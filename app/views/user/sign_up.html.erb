<script>
    function toggle_terms_accept() {
        let terms_accpeted = document.getElementById("terms_accepted");
        terms_accpeted.setAttribute("value", String(!(String(true) === terms_accpeted.value)));
    }

    function fetchUUID() {
        let timeout = null;
        let username_form  = document.getElementById('minecraft_username');
        let uuid_form  = document.getElementById('minecraft_uuid');
        let loading_overlay = document.getElementById('minecraft-loading');
        loading_overlay.hidden = true
        console.log("fetch init")
        username_form.addEventListener('keyup', function (e) {
            clearTimeout(timeout);
            timeout = setTimeout(function () {
                if (username_form.value.length > 3) {
                    let username = username_form.value
                    loading_overlay.hidden = false
                    fetch("<%= root_url %>" + "api/minecraft/mainline/users/uuid/" + username)
                        .then(response => {
                            if (response.status >= 200 && response.status < 300) {
                                response.json()
                                .then(json => {
                                    if (json !== null) {
                                        fetch("<%= root_url %>" + "api/nachtbeere/users/uuid/" + json['id'])
                                            .then(response => response.json())
                                            .then(json => json['duplicated'])
                                            .then(function (duplicated) {
                                                if (duplicated) {
                                                    username_form.classList.remove("uk-form-success")
                                                    username_form.classList.add("uk-form-danger")
                                                } else {
                                                    uuid_form.setAttribute("value", json['id'])
                                                    username_form.classList.remove("uk-form-danger")
                                                    username_form.classList.add("uk-form-success")
                                                }
                                                loading_overlay.hidden = true
                                            })
                                    } else {
                                        loading_overlay.hidden = true
                                    }
                                })
                            } else {
                                loading_overlay.hidden = true
                            }
                        })
                }
            }, 500);
        });
    }
    window.onload = function() {
        fetchUUID()
    }
</script>
<% breadcrumb :sign_up %>
<!--<div class="uk-width-medium uk-padding-small uk-position-z-index uk-scrollspy-inview uk-animation-fade" uk-scrollspy="cls: uk-animation-fade" style="">-->
<div class="uk-text-center uk-margin">
  <h1>가입하기</h1>
  <!--    <img src="img/login-logo.svg" alt="Logo">-->
</div>
<%= form_for '/sign-up', html: {class: "toggle-class"} do %>
  <fieldset class="uk-fieldset">
    <div class="uk-margin-small">
      <div class="uk-grid">
        <div class="uk-inline uk-width-1-4 flex-category" style="text-align: right">
          <span>이메일 주소</span>
        </div>
        <div class="uk-inline uk-width-expand">
          <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: mail"></span>
          <%= email_field_tag :email, "", {placeholder: "로그인과 비밀번호 찾기에 사용됩니다", class: "uk-input uk-border-pill flex-placeholder", required: "required"} %>
        </div>
      </div>
    </div>
    <div class="uk-margin-small">
      <div class="uk-grid">
        <div class="uk-inline uk-width-1-4 flex-category" style="text-align: right">
          <span>유저네임</span>
        </div>
        <div class="uk-inline uk-width-expand">
          <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: user"></span>
          <%= text_field_tag :username, "", {placeholder: "게시판, 댓글 등에 표시됩니다", class: "uk-input uk-border-pill flex-placeholder", required: "required"} %>
        </div>
      </div>
    </div>
    <div class="uk-margin-small">
      <div class="uk-grid">
        <div class="uk-inline uk-width-1-4 flex-category" style="text-align: right">
          <span>비밀번호</span>
        </div>
        <div class="uk-inline uk-width-expand">
          <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: lock"></span>
          <%= password_field_tag :password, "", {placeholder: "영문 대소문자, 숫자, 특수문자 8자 이상", class: "uk-input uk-border-pill flex-placeholder", required: "required"} %>
        </div>
      </div>
    </div>
    <div class="uk-margin-small">
      <div class="uk-grid">
        <div class="uk-inline uk-width-1-4 flex-category" style="text-align: right">
          <span>비밀번호 확인</span>
        </div>
        <div class="uk-inline uk-width-expand">
          <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: lock"></span>
          <%= password_field_tag :password_confirmation, "", {placeholder: "영문 대소문자, 숫자, 특수문자 8자 이상", class: "uk-input uk-border-pill flex-placeholder", required: "required"} %>
        </div>
      </div>
    </div>
    <div class="uk-margin-small">
      <div class="uk-grid">
        <div class="uk-inline uk-width-1-4 flex-category" style="text-align: right">
          <span>마인크래프트 유저네임</span>
        </div>
        <div class="uk-inline uk-width-expand">
          <span class="uk-form-icon uk-form-icon-flip" uk-icon="icon: world"></span>
          <div id="minecraft-loading" class="uk-overlay uk-overlay-default uk-position-cover">
            <span uk-spinner class="uk-form-icon"></span>
          </div>
          <%= text_field_tag :minecraft_username, "", {placeholder: "없으면 비워도 됩니다", class: "uk-input uk-border-pill flex-placeholder"} %>
          <%= hidden_field_tag :minecraft_uuid, "", style: 'visibility: hidden' %>
        </div>
      </div>
    </div>
    <div class="uk-margin-small">
      <div class="uk-grid">
        <div class="uk-inline uk-width-1-4 flex-category" style="text-align: right">
          <span><a href="terms-of-service" target="_blank">이용약관</a>에</span>
        </div>
        <div class="uk-inline uk-width-expand">
          <%= button_tag "동의하지 않습니다", {type: "button", name: "동의합니다", onclick: "toggle_terms_accept();", data: {"uk-toggle": "target: .toggle-animation-queued; animation: uk-animation-fade; queued: true; duration: 300"}, class: "toggle-animation-queued uk-button uk-button-default uk-width-1-1 uk-margin-small-bottom", required: "required"} %>
          <%= button_tag "동의합니다", {type: "button", name: "동의합니다", onclick: "toggle_terms_accept();", data: {"uk-toggle": "target: .toggle-animation-queued; animation: uk-animation-fade; queued: true; duration: 300"}, class: "toggle-animation-queued uk-button uk-button-primary uk-width-1-1 uk-margin-small-bottom", hidden: "hidden"} %>
          <%= hidden_field_tag :terms_accepted, false, style: 'visibility: hidden' %>
        </div>
      </div>
    </div>
      <%= submit_tag "가입", {class: "uk-button uk-button-primary uk-width-1-1 uk-margin-small-bottom"} %>
  </fieldset>
<% end %>
